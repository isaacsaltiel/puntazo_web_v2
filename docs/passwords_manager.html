<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestor de passwords.json (Puntazo)</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--primary:#60a5fa}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    body{margin:0;background:linear-gradient(120deg,#0b1225,#0f172a);color:var(--ink)}
    header{padding:18px 20px;border-bottom:1px solid #1f2937;display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px 0;font-size:16px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{width:100%;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--ink);padding:10px}
    textarea{min-height:240px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #334155;background:#0b1220;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .btn{cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);border-color:#3b82f6}
    .btn.ghost{background:#0b1220}
    .btn.danger{border-color:#b91c1c;color:#fecaca}
    .flex{display:flex;gap:10px;align-items:center}
    .mt8{margin-top:8px} .mt12{margin-top:12px} .mt16{margin-top:16px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <header>
    <h1>Gestor de <span class="mono">data/passwords.json</span> · Puntazo</h1>
    <span class="pill">SHA‑256 · orden por <b>loc</b>, luego <b>can</b></span>
  </header>

  <main>
    <!-- JSON actual -->
    <section class="card">
      <h2>1) Pega tu <span class="mono">passwords.json</span> actual</h2>
      <textarea id="inputJson" spellcheck="false" class="mono" placeholder='{
  "canchas": [
    {
      "loc": "Scorpion",
      "can": "Cancha1",
      "enabled": true,
      "sha256": "92e85269b76b64e688796648228d8c4f7b0f167b46130bb9c4bfa454923f64bd",
      "remember_hours": 24
    }
  ]
}'></textarea>
      <div class="flex mt8">
        <button class="btn" id="btnCargar">Cargar JSON</button>
        <button class="btn ghost" id="btnFormatear">Formatear</button>
        <span id="estado" class="hint"></span>
      </div>
      <p class="hint mt8">Consejo: guarda este HTML y ábrelo localmente. Todo ocurre en tu navegador; nada se sube.</p>
    </section>

    <!-- Editor de entrada -->
    <section class="card">
      <h2>2) Editar/Agregar cancha</h2>
      <div class="row">
        <div>
          <label>ID del club (loc)</label>
          <input id="loc" placeholder="Scorpion" />
        </div>
        <div>
          <label>ID de la cancha (can)</label>
          <input id="can" placeholder="Cancha1" />
        </div>
      </div>
      <div class="row3 mt8">
        <div>
          <label>¿Habilitar contraseña? (enabled)</label>
          <select id="enabled">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div>
          <label>Recordar (horas) (remember_hours)</label>
          <input id="remember" type="number" min="1" placeholder="24" />
        </div>
        <div>
          <label>Contraseña (texto plano para hash)</label>
          <input id="pwd" type="text" placeholder="Deja vacío si no cambias" />
        </div>
      </div>
      <div class="mt12">
        <label>Hash SHA‑256 (hex) — se autocompleta si pones contraseña arriba</label>
        <input id="sha" class="mono" placeholder="64 chars hex" />
        <div class="hint mt8">La web <strong>usa solo el hash</strong>. No guardes contraseñas en texto en el JSON.</div>
      </div>
      <div class="row mt12">
        <button id="btnAgregarActualizar" class="btn primary">Agregar / Actualizar</button>
        <button id="btnDesactivar" class="btn">Desactivar (enabled:false)</button>
      </div>
      <div class="row mt8">
        <button id="btnEliminar" class="btn danger">Eliminar cancha</button>
        <button id="btnBuscar" class="btn">Buscar y cargar en el formulario</button>
      </div>
      <div id="msg" class="hint mt12"></div>
    </section>

    <!-- Resultado -->
    <section class="card" style="grid-column:1/3">
      <h2>3) Resultado · <span class="mono">passwords.json</span></h2>
      <textarea id="outJson" spellcheck="false" class="mono"></textarea>
      <div class="flex mt8">
        <button class="btn" id="btnCopiar">Copiar</button>
        <button class="btn" id="btnDescargar">Descargar passwords.json</button>
        <span id="outInfo" class="hint"></span>
      </div>
    </section>
  </main>

  <script>
    /** Utilidades **/
    function parseJsonSafe(txt){ try{ return JSON.parse(txt) }catch{ return null } }

    function normalizeModel(m){
      if(!m || typeof m !== 'object') m={};
      if(!Array.isArray(m.canchas)) m.canchas=[];
      // normaliza campos y ordena por loc+can
      m.canchas = m.canchas.map(x=>({
        loc: String(x.loc||''),
        can: String(x.can||''),
        enabled: Boolean(x.enabled),
        sha256: String(x.sha256||'').toLowerCase(),
        remember_hours: Number.isFinite(Number(x.remember_hours)) && Number(x.remember_hours)>0 ? Number(x.remember_hours) : 24
      })).sort((a,b)=> a.loc.localeCompare(b.loc) || a.can.localeCompare(b.can));
      return m;
    }

    function isHex64(s){ return /^[0-9a-f]{64}$/i.test(s||'') }

    async function sha256Hex(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function setStatus(msg, cls=''){ const el=document.getElementById('estado'); el.textContent=msg; el.className='hint '+cls }
    function setMsg(msg, cls=''){ const el=document.getElementById('msg'); el.textContent=msg; el.className='hint '+cls }
    function setOutInfo(msg, cls=''){ const el=document.getElementById('outInfo'); el.textContent=msg; el.className='hint '+cls }

    function renderOut(model){
      document.getElementById('outJson').value = JSON.stringify(model, null, 2);
      setOutInfo(`Entradas: ${model.canchas.length}`);
    }

    // Estado en memoria
    let model = { canchas: [] };

    // Botones base
    document.getElementById('btnCargar').onclick = () => {
      const m = parseJsonSafe(document.getElementById('inputJson').value.trim());
      if(!m){ setStatus('JSON inválido', 'err'); return }
      model = normalizeModel(m);
      renderOut(model);
      setStatus('JSON cargado y normalizado', 'ok');
    }

    document.getElementById('btnFormatear').onclick = () => {
      const m = parseJsonSafe(document.getElementById('inputJson').value.trim());
      if(!m){ setStatus('JSON inválido', 'err'); return }
      const n = normalizeModel(m);
      document.getElementById('inputJson').value = JSON.stringify(n, null, 2);
      setStatus('Formateado ✓', 'ok');
    }

    // Editor
    document.getElementById('btnBuscar').onclick = () => {
      const loc = document.getElementById('loc').value.trim();
      const can = document.getElementById('can').value.trim();
      const x = model.canchas.find(e=>e.loc===loc && e.can===can);
      if(!x){ setMsg('No se encontró esa cancha en el JSON cargado.', 'warn'); return }
      document.getElementById('enabled').value = String(x.enabled);
      document.getElementById('remember').value = String(x.remember_hours);
      document.getElementById('sha').value = x.sha256;
      setMsg('Entrada cargada en el formulario', 'ok');
    }

    document.getElementById('pwd').addEventListener('input', async (e)=>{
      const t = e.target.value;
      if(t.length>0){
        const h = await sha256Hex(t);
        document.getElementById('sha').value = h;
      }
    })

    document.getElementById('btnAgregarActualizar').onclick = () => {
      const loc = document.getElementById('loc').value.trim();
      const can = document.getElementById('can').value.trim();
      const enabled = document.getElementById('enabled').value === 'true';
      const remember = Number(document.getElementById('remember').value)||24;
      const sha = (document.getElementById('sha').value||'').toLowerCase();

      if(!loc || !can){ setMsg('loc y can son obligatorios.', 'err'); return }
      if(enabled && !isHex64(sha)){ setMsg('enabled:true requiere sha256 válido (64 hex).', 'err'); return }

      const idx = model.canchas.findIndex(e=>e.loc===loc && e.can===can);
      const entry = { loc, can, enabled, sha256: sha, remember_hours: remember>0?remember:24 };
      if(idx>=0) model.canchas[idx]=entry; else model.canchas.push(entry);
      model = normalizeModel(model);
      renderOut(model);
      setMsg(idx>=0? 'Actualizado ✓':'Agregado ✓', 'ok');
    }

    document.getElementById('btnDesactivar').onclick = () => {
      const loc = document.getElementById('loc').value.trim();
      const can = document.getElementById('can').value.trim();
      if(!loc || !can){ setMsg('loc y can son obligatorios.', 'err'); return }
      const idx = model.canchas.findIndex(e=>e.loc===loc && e.can===can);
      if(idx<0){ setMsg('No existe esa cancha.', 'warn'); return }
      model.canchas[idx].enabled = false;
      model = normalizeModel(model);
      renderOut(model);
      setMsg('Desactivada (enabled:false) ✓', 'ok');
    }

    document.getElementById('btnEliminar').onclick = () => {
      const loc = document.getElementById('loc').value.trim();
      const can = document.getElementById('can').value.trim();
      if(!loc || !can){ setMsg('loc y can son obligatorios.', 'err'); return }
      const len0 = model.canchas.length;
      model.canchas = model.canchas.filter(e=>!(e.loc===loc && e.can===can));
      model = normalizeModel(model);
      renderOut(model);
      setMsg(model.canchas.length<len0? 'Eliminada ✓':'No existía esa cancha', model.canchas.length<len0?'ok':'warn');
    }

    document.getElementById('btnCopiar').onclick = async () => {
      try{
        await navigator.clipboard.writeText(document.getElementById('outJson').value);
        setOutInfo('Copiado al portapapeles ✓', 'ok');
      }catch{ setOutInfo('No se pudo copiar', 'err') }
    }

    document.getElementById('btnDescargar').onclick = () => {
      const blob = new Blob([document.getElementById('outJson').value], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'passwords.json'; a.click();
      setOutInfo('Descarga iniciada ✓', 'ok');
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // Inicializa con el ejemplo del placeholder
    (function init(){
      const demo = document.getElementById('inputJson').value;
      const m = parseJsonSafe(demo);
      model = normalizeModel(m);
      renderOut(model);
      setStatus('Demo cargado');
    })();
  </script>
</body>
</html>
